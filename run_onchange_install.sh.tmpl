#!/bin/sh

if [ -z ${ZSH} ]; then
    # install oh-my-zsh
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    mv ~/.zshrc.pre-oh-my-zsh ~/.zshrc
fi

# -------------------------
# macOS
# -------------------------
{{ if eq .chezmoi.os "darwin" -}}
# install brew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
# install packages
brew install neovim tmux hub chezmoi ripgrep fzf xclip neofetch
brew install --cask iterm2 karabiner-elements

# -------------------------
# Raspberry Pi / Raspbian
# -------------------------
{{ else if eq .chezmoi.osRelease.id "raspbian" -}}
sudo apt-get update -y && sudo apt-get upgrade -y
sudo apt-get install zsh tmux hub ripgrep fzf xclip snapd git neofetch -y
sudo snap install chezmoi --classic
sudo snap install nvim --classic
sudo chsh -s $(which zsh)

# -------------------------
# Linux (Arch-based)
# -------------------------
{{ else if eq .chezmoi.os "linux" -}}
# Detect Arch via pacman
if command -v pacman >/dev/null 2>&1; then
    sudo pacman -Syu --noconfirm
    sudo pacman -S --needed neovim tmux hub chezmoi ripgrep fzf xclip neofetch --noconfirm

# -------------------------
# Linux (Debian/Ubuntu-based)
# -------------------------
elif command -v apt-get >/dev/null 2>&1; then
    sudo apt-get update -y && sudo apt-get upgrade -y
    sudo apt-get install -y zsh neovim tmux hub chezmoi ripgrep fzf xclip git neofetch curl
    # set default shell to zsh
    sudo chsh -s $(which zsh)
fi
{{ end -}}

# -------------------------
# OS independent installs
# -------------------------

# install nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# install node + global packages
nvm install --lts
npm install -g yarn
npm install -g browser-sync

if [ -z ${ZSH} ]; then
    # install powerlevel10k
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k

    # install tmux plugin manager
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
fi

# set chezmoi repo to use ssh
cd ~/.local/share/chezmoi
git remote set-url origin git@github.com:justjcurtis/dotfiles.git
cd -
